<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/Wrapper.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Wrapper.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">16.67% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>1/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/27</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// contracts/Wrapper.sol
// SPDX-License-Identifier: MIT
pragma solidity 0.8.12;
&nbsp;
import {PartialCommonOwnership as PCO} from "./token/PartialCommonOwnership.sol";
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/IERC721Metadata.sol";
&nbsp;
struct WrappedToken {
  /// @notice Issuing contract address.
  address contractAddress;
  /// @notice Underlying token ID (issued when minted).
  uint256 tokenId;
  /// @notice Address that wrapped the token.
  address operatorAddress;
}
&nbsp;
/// @title Wrapper
/// @author Will Holley (@will-holley)
/// @author Victor Sint Nicolaas (@vicsn)
/// @notice This contract can wrap or hold other tokens adhering to the ERC721
/// standard, and is partially common owned (see PCO).
contract Wrapper is PCO {
  //////////////////////////////
  /// State
  //////////////////////////////
&nbsp;
  /// @notice Mapping from Wrapped Token IDs to metadata on the underlying token.
  mapping(uint256 =&gt; WrappedToken) private _wrappedTokenMap;
&nbsp;
  //////////////////////////////
  /// Events
  //////////////////////////////
&nbsp;
  /// @notice Alert that a token has been wrapped
  /// @param contractAddress See WrappedToken.contractAddress
  /// @param tokenId See WrappedToken.tokenId
  /// @param wrappedTokenId The Wrapped Token ID.
  event LogTokenWrapped(
    address contractAddress,
    uint256 tokenId,
    uint256 wrappedTokenId
  );
&nbsp;
  //////////////////////////////
  /// Constructor
  //////////////////////////////
&nbsp;
  /// @notice Creates the Wrapper.
  /// @param name_ PCO Contract Name.
  /// @param symbol_ PCO Contract Symbol.
  /* solhint-disable no-empty-blocks */
  constructor(string memory name_, string memory symbol_) PCO(name_, symbol_) {}
&nbsp;
  /* solhint-enable no-empty-blocks */
&nbsp;
  //////////////////////////////
  /// Public Methods
  //////////////////////////////
&nbsp;
  /// @notice Takes possession of a given token, creating a "wrapped" version that complies with
  /// Partial Common Ownership. The new token is returned to the owner.
  /// @dev Note that `#safeTransferFrom` first requires that contract address is
  /// approved by `msg.sender`.
  /// @param tokenContractAddress_ Issuing contract address for token to be wrapped.
  /// @param tokenId_ ID of token to be wrapped
  /// @param valuation_ Self assessed valuation of the token.
  /// @param beneficiary_ See `PCO._beneficiaries`.
  /// @param taxRate_ See `PCO._taxNumerators`.
  /// @param collectionFrequency_ See `PCO._taxPeriods`.
<span class="fstat-no" title="function not covered" >  function wrap(</span>
    address tokenContractAddress_,
    uint256 tokenId_,
    uint256 valuation_,
    address payable beneficiary_,
    uint256 taxRate_,
    uint256 collectionFrequency_
  ) public payable {
    // Assertions
<span class="cstat-no" title="statement not covered" >    require(valuation_ &gt; 0, "Valuation must be &gt; 0")</span>;
<span class="cstat-no" title="statement not covered" >    require(beneficiary_ != address(0), "Beneficiary cannot be address zero")</span>;
<span class="cstat-no" title="statement not covered" >    require(taxRate_ &gt; 0, "Tax rate must be &gt; 0")</span>;
<span class="cstat-no" title="statement not covered" >    require(collectionFrequency_ &gt; 0, "Tax frequency must be &gt; 0")</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >    IERC721 tokenContract = IERC721(tokenContractAddress_);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (msg.sender == beneficiary_) {</span>
      // If sender is the beneficiary, ensure they did not send a deposit
<span class="cstat-no" title="statement not covered" >      require(msg.value == 0, "No deposit required")</span>;
    } else {
<span class="cstat-no" title="statement not covered" >      require(msg.value &gt; 0, "Deposit required")</span>;
    }
&nbsp;
    // Transfer ownership of the token to this contract.
<span class="cstat-no" title="statement not covered" >    tokenContract.safeTransferFrom(msg.sender, address(this), tokenId_)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >    uint256 _wrappedTokenId = wrappedTokenId(tokenContractAddress_, tokenId_);</span>
<span class="cstat-no" title="statement not covered" >    _wrappedTokenMap[_wrappedTokenId] = WrappedToken({</span>
      contractAddress: tokenContractAddress_,
      tokenId: tokenId_,
      operatorAddress: msg.sender
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    _mint(</span>
      _wrappedTokenId,
      msg.sender,
      msg.value,
      valuation_,
      beneficiary_,
      taxRate_,
      collectionFrequency_
    );
&nbsp;
<span class="cstat-no" title="statement not covered" >    emit LogTokenWrapped(tokenContractAddress_, tokenId_, _wrappedTokenId);</span>
  }
&nbsp;
  /// @notice Unwrap a given token. Only callable by the address that originally
  /// wrapped the token. Burns the wrapped token and transfers the underlying token
  /// to the last owner of the wrapped token.
  /// @param tokenId_ Id of wrapped token.
<span class="fstat-no" title="function not covered" >  function unwrap(uint256 tokenId_) public _tokenMinted(tokenId_) {</span>
<span class="cstat-no" title="statement not covered" >    WrappedToken memory token = _wrappedTokenMap[tokenId_];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    require(token.operatorAddress == msg.sender, "Wrap originator only")</span>;
&nbsp;
    // Get current owner's address prior to burning.
<span class="cstat-no" title="statement not covered" >    address owner = ownerOf(tokenId_);</span>
&nbsp;
    // Delete wrapper state
    delete _wrappedTokenMap[tokenId_];
&nbsp;
    // Burn the token
<span class="cstat-no" title="statement not covered" >    _burn(tokenId_)</span>;
&nbsp;
    // Transfer ownership of the underlying token to the current owner
<span class="cstat-no" title="statement not covered" >    IERC721 tokenContract = IERC721(token.contractAddress);</span>
<span class="cstat-no" title="statement not covered" >    tokenContract.safeTransferFrom(address(this), owner, token.tokenId)</span>;
  }
&nbsp;
  /// @notice Queries the wrapped token's URI.
  /// @param tokenId_ See IERC721
  /// @return Token URI string.
<span class="fstat-no" title="function not covered" >  function tokenURI(uint256 tokenId_)</span>
    public
    view
    override
    returns (string memory)
  {
<span class="cstat-no" title="statement not covered" >    require(</span>
      _exists(tokenId_),
      "ERC721Metadata: URI query for nonexistent token"
    );
&nbsp;
<span class="cstat-no" title="statement not covered" >    WrappedToken memory wrappedToken = _wrappedTokenMap[tokenId_];</span>
<span class="cstat-no" title="statement not covered" >    IERC721Metadata metadata = IERC721Metadata(wrappedToken.contractAddress);</span>
<span class="cstat-no" title="statement not covered" >    return metadata.tokenURI(wrappedToken.tokenId);</span>
  }
&nbsp;
  /// @notice Mints the wrapped token.
  /// @dev Envoked by `#wrap`.
  /// @param operator_ Address that initiated the token transfer.
  /// @param from_ Address of the contract that issued this token.
  /// @param tokenId_ Id of token received.
  /// @param data_ Unused call data.
  /// @return Must return its Solidity selector to confirm the token transfer.
  /// Returning any other value or interface will revert the transfer.
  /* solhint-disable no-unused-vars */
<span class="fstat-no" title="function not covered" >  function onERC721Received(</span>
    address operator_,
    address from_,
    uint256 tokenId_,
    bytes memory data_
  ) public view returns (bytes4) {
    // Ensure that the token was not errantly sent. This ensures that the self-assesssed valuation
    // and taxation information are set.
<span class="cstat-no" title="statement not covered" >    require(</span>
      operator_ == address(this),
      "Tokens can only be received via #wrap"
    );
&nbsp;
<span class="cstat-no" title="statement not covered" >    return this.onERC721Received.selector;</span>
  }
&nbsp;
  /* solhint-enable no-unused-vars */
&nbsp;
  /// @notice Deterministically generates wrapped token IDs given the token's
  /// contract address and ID.
  /// @param contractAddress_ Issuing contract address
  /// @param tokenId_ Token ID
  /// @return Wrapped Token ID
<span class="fstat-no" title="function not covered" >  function wrappedTokenId(address contractAddress_, uint256 tokenId_)</span>
    public
    pure
    returns (uint256)
  {
<span class="cstat-no" title="statement not covered" >    return uint256(bytes32(keccak256(abi.encode(contractAddress_, tokenId_))));</span>
  }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Apr 05 2022 22:55:51 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
